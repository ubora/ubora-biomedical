using FluentAssertions;
using Ubora.Domain.Infrastructure.Marten;
using Ubora.Domain.Tests.Helpers;
using Xunit;

namespace Ubora.Domain.Tests
{
    public class QuillDeltaTests
    {
        [Fact]
        public void QuillDelta_Is_Compressed_And_Can_Be_Serialized_And_Deserialized()
        {
            var initialValue = "{\"ops\":[{\"insert\":\"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras turpis augue, ornare sed libero sit amet, luctus gravida ante. Morbi enim lorem, feugiat ac risus eu, lobortis venenatis erat. Nam eu nibh congue, facilisis dui at, hendrerit mi. Sed semper nulla vel ornare aliquam. Nullam commodo augue ut massa gravida aliquam. Nam aliquam sagittis felis non vulputate. Fusce tincidunt ante nec placerat faucibus. Curabitur fringilla risus ut quam commodo, eget rhoncus nibh eleifend. Integer ligula nisi, bibendum nec mollis sed, ullamcorper ac est. Cras ornare feugiat ante, vel maximus ex pellentesque ut. Sed a lobortis dolor, vitae ullamcorper sapien. Sed sit amet ullamcorper metus, sed dignissim ante. Aliquam erat volutpat. Vivamus sed egestas urna. Sed eleifend condimentum dolor ac vestibulum.\\nNunc elementum porta tempus. Maecenas rutrum nibh ipsum, non imperdiet leo tempor condimentum. Vestibulum sit amet ornare magna. Praesent pretium ultrices tempor. Sed congue nibh in vestibulum lobortis. Aliquam augue augue, hendrerit eget turpis quis, aliquam porttitor orci. Suspendisse malesuada nulla sed eros ultricies ultrices. Cras rutrum laoreet auctor. In diam nibh, bibendum quis nisl ut, tristique mollis eros. Nullam sit amet posuere sem, tincidunt finibus dui.\\n\"},{\"attributes\":{\"underline\":true},\"insert\":\"Morbi vulputate diam at eros lacinia cursus. In sodales, elit semper placerat ullamcorper, dolor risus mollis neque, id faucibus eros turpis id est. Fusce diam risus, vestibulum pulvinar iaculis at, mollis quis sapien. Sed porttitor nulla eu ante ornare, gravida varius odio pretium. Duis laoreet libero at justo scelerisque volutpat et finibus leo. Cras suscipit egestas tempor. Nunc vel augue venenatis diam vestibulum porttitor. Sed tincidunt lacus dui, a iaculis sapien sagittis blandit. Sed pellentesque, lectus eget volutpat feugiat, libero lectus lacinia tortor, quis convallis lectus tellus laoreet lacus. Sed id euismod erat. Donec cursus justo tristique lectus dapibus, ac lacinia elit maximus.\"},{\"insert\":\"\\nDonec eget ornare eros. Aenean aliquam interdum odio. Integer ultricies nisi tortor, eget elementum enim gravida ut. Praesent eros tellus, pharetra a lacus eu, lacinia feugiat erat. Ut non erat nulla. Sed sit amet faucibus elit. Fusce varius porttitor felis vel tincidunt. Aenean lacinia enim quis sagittis vestibulum. Cras pharetra placerat varius. Nulla sodales magna in neque auctor porttitor. Ut varius volutpat efficitur. Curabitur ut velit et justo auctor molestie.\\nNullam id feugiat orci. Vestibulum porta posuere pretium. Sed ac pellentesque augue. Sed commodo iaculis tortor, ultricies posuere ligula volutpat a. Donec ut condimentum lectus. Cras consequat ornare erat, in congue felis auctor laoreet. Cras turpis tortor, iaculis finibus hendrerit nec, mattis in felis. Aenean sollicitudin odio non dui gravida, imperdiet commodo turpis efficitur. Etiam id quam neque. Etiam pellentesque blandit orci, sit amet cursus justo. Nulla at suscipit leo, sed aliquet lorem. Pellentesque bibendum porttitor sapien et gravida. Maecenas ac accumsan mi, vitae ultrices ipsum. Cras sagittis, neque sodales ultricies luctus, augue nibh elementum lacus, vitae ultrices magna dui ac justo. Integer vitae eros at ligula varius vulputate vitae ac mi.\\nNunc ultrices pulvinar elementum. Aenean egestas hendrerit odio, a porttitor dui finibus quis. Pellentesque suscipit eu quam sodales molestie. Curabitur vel maximus lorem. Vivamus sem metus, blandit non magna ut, vehicula vestibulum neque. Fusce in mauris aliquet, dapibus magna ut, iaculis ex. Fusce orci metus, ultricies et tincidunt maximus, tempus a leo. Sed tellus sapien, ullamcorper at libero at, pharetra lobortis nisl. Ut magna diam, consequat scelerisque tortor ac, convallis facilisis tortor. Mauris elementum vehicula dolor viverra accumsan. In a ex molestie, hendrerit purus ac, consequat arcu. In et velit sit amet sem vulputate efficitur sed nec ligula. Proin volutpat, ipsum in porttitor molestie, eros elit ornare libero, vel lacinia odio erat non tortor. Nulla non lorem et velit posuere pretium. Nam a mauris tortor.\\nCurabitur posuere ac lectus ac efficitur. Vestibulum vitae nibh sed lacus tincidunt pulvinar. Duis consectetur laoreet nulla id imperdiet. Ut pulvinar eros dui, iaculis eleifend metus luctus in. Maecenas tincidunt ut urna porta eleifend. Donec scelerisque mattis eros a porta. Suspendisse a viverra ipsum.\\n\"},{\"attributes\":{\"italic\":true},\"insert\":\"Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Curabitur imperdiet sollicitudin arcu eget posuere. Ut quis odio massa. Nam eu auctor dolor, quis porttitor eros. Maecenas consectetur purus sit amet ligula pretium tincidunt. Donec quis tortor sed est semper pellentesque. Sed vel egestas sem, sed fringilla nunc. Cras sodales et ante nec vehicula. Cras ornare pharetra est, vel commodo tortor mattis sit amet. Vivamus commodo, felis vitae efficitur ultricies, mauris est gravida neque, a sodales ligula ipsum vitae nibh. Nam eleifend ullamcorper sodales. Mauris tempus nunc ligula, sit amet congue tellus dignissim ut. Quisque ornare, enim nec fringilla lacinia, urna nulla fringilla erat, vitae aliquam sapien urna in nunc. Maecenas rutrum, orci in ornare egestas, nisl enim vestibulum nulla, at faucibus massa nibh laoreet dolor.\"},{\"insert\":\"\\n\"},{\"attributes\":{\"bold\":true},\"insert\":\"Mauris lectus augue, maximus a vehicula et, placerat quis erat. Etiam eu dapibus enim, ac gravida massa. Duis nec rutrum erat. Sed consectetur, nunc ut auctor iaculis, nunc neque placerat orci, in rutrum justo elit eleifend ex. Proin tristique quam et commodo consectetur. Mauris et velit eget dolor facilisis varius. Vivamus eros orci, volutpat vitae ex ullamcorper, commodo vehicula nunc. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer nulla ipsum, vestibulum gravida lobortis et, aliquam eu turpis. Vivamus pharetra pellentesque massa, vel vehicula urna vulputate in.\"},{\"insert\":\"\\nPellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Etiam varius risus et pretium malesuada. Maecenas ultricies ullamcorper arcu ac laoreet. Aliquam eleifend cursus condimentum. Nam sed ornare erat. Fusce ac dui ligula. Suspendisse elementum nibh venenatis aliquet malesuada.Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras turpis augue, ornare sed libero sit amet, luctus gravida ante. Morbi enim lorem, feugiat ac risus eu, lobortis venenatis erat. Nam eu nibh congue, facilisis dui at, hendrerit mi. Sed semper nulla vel ornare aliquam. Nullam commodo augue ut massa gravida aliquam. Nam aliquam sagittis felis non vulputate. Fusce tincidunt ante nec placerat faucibus. Curabitur fringilla risus ut quam commodo, eget rhoncus nibh eleifend. Integer ligula nisi, bibendum nec mollis sed, ullamcorper ac est. Cras ornare feugiat ante, vel maximus ex pellentesque ut. Sed a lobortis dolor, vitae ullamcorper sapien. Sed sit amet ullamcorper metus, sed dignissim ante. Aliquam erat volutpat. Vivamus sed egestas urna. Sed eleifend condimentum dolor ac vestibulum.\\nNunc elementum porta tempus. Maecenas rutrum nibh ipsum, non imperdiet leo tempor condimentum. Vestibulum sit amet ornare magna. Praesent pretium ultrices tempor. Sed congue nibh in vestibulum lobortis. Aliquam augue augue, hendrerit eget turpis quis, aliquam porttitor orci. Suspendisse malesuada nulla sed eros ultricies ultrices. Cras rutrum laoreet auctor. In diam nibh, bibendum quis nisl ut, tristique mollis eros. Nullam sit amet posuere sem, tincidunt finibus dui.\\n\"},{\"attributes\":{\"underline\":true},\"insert\":\"Morbi vulputate diam at eros lacinia cursus. In sodales, elit semper placerat ullamcorper, dolor risus mollis neque, id faucibus eros turpis id est. Fusce diam risus, vestibulum pulvinar iaculis at, mollis quis sapien. Sed porttitor nulla eu ante ornare, gravida varius odio pretium. Duis laoreet libero at justo scelerisque volutpat et finibus leo. Cras suscipit egestas tempor. Nunc vel augue venenatis diam vestibulum porttitor. Sed tincidunt lacus dui, a iaculis sapien sagittis blandit. Sed pellentesque, lectus eget volutpat feugiat, libero lectus lacinia tortor, quis convallis lectus tellus laoreet lacus. Sed id euismod erat. Donec cursus justo tristique lectus dapibus, ac lacinia elit maximus.\"},{\"insert\":\"\\nDonec eget ornare eros. Aenean aliquam interdum odio. Integer ultricies nisi tortor, eget elementum enim gravida ut. Praesent eros tellus, pharetra a lacus eu, lacinia feugiat erat. Ut non erat nulla. Sed sit amet faucibus elit. Fusce varius porttitor felis vel tincidunt. Aenean lacinia enim quis sagittis vestibulum. Cras pharetra placerat varius. Nulla sodales magna in neque auctor porttitor. Ut varius volutpat efficitur. Curabitur ut velit et justo auctor molestie.\\nNullam id feugiat orci. Vestibulum porta posuere pretium. Sed ac pellentesque augue. Sed commodo iaculis tortor, ultricies posuere ligula volutpat a. Donec ut condimentum lectus. Cras consequat ornare erat, in congue felis auctor laoreet. Cras turpis tortor, iaculis finibus hendrerit nec, mattis in felis. Aenean sollicitudin odio non dui gravida, imperdiet commodo turpis efficitur. Etiam id quam neque. Etiam pellentesque blandit orci, sit amet cursus justo. Nulla at suscipit leo, sed aliquet lorem. Pellentesque bibendum porttitor sapien et gravida. Maecenas ac accumsan mi, vitae ultrices ipsum. Cras sagittis, neque sodales ultricies luctus, augue nibh elementum lacus, vitae ultrices magna dui ac justo. Integer vitae eros at ligula varius vulputate vitae ac mi.\\nNunc ultrices pulvinar elementum. Aenean egestas hendrerit odio, a porttitor dui finibus quis. Pellentesque suscipit eu quam sodales molestie. Curabitur vel maximus lorem. Vivamus sem metus, blandit non magna ut, vehicula vestibulum neque. Fusce in mauris aliquet, dapibus magna ut, iaculis ex. Fusce orci metus, ultricies et tincidunt maximus, tempus a leo. Sed tellus sapien, ullamcorper at libero at, pharetra lobortis nisl. Ut magna diam, consequat scelerisque tortor ac, convallis facilisis tortor. Mauris elementum vehicula dolor viverra accumsan. In a ex molestie, hendrerit purus ac, consequat arcu. In et velit sit amet sem vulputate efficitur sed nec ligula. Proin volutpat, ipsum in porttitor molestie, eros elit ornare libero, vel lacinia odio erat non tortor. Nulla non lorem et velit posuere pretium. Nam a mauris tortor.\\nCurabitur posuere ac lectus ac efficitur. Vestibulum vitae nibh sed lacus tincidunt pulvinar. Duis consectetur laoreet nulla id imperdiet. Ut pulvinar eros dui, iaculis eleifend metus luctus in. Maecenas tincidunt ut urna porta eleifend. Donec scelerisque mattis eros a porta. Suspendisse a viverra ipsum.\\n\"},{\"attributes\":{\"italic\":true},\"insert\":\"Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Curabitur imperdiet sollicitudin arcu eget posuere. Ut quis odio massa. Nam eu auctor dolor, quis porttitor eros. Maecenas consectetur purus sit amet ligula pretium tincidunt. Donec quis tortor sed est semper pellentesque. Sed vel egestas sem, sed fringilla nunc. Cras sodales et ante nec vehicula. Cras ornare pharetra est, vel commodo tortor mattis sit amet. Vivamus commodo, felis vitae efficitur ultricies, mauris est gravida neque, a sodales ligula ipsum vitae nibh. Nam eleifend ullamcorper sodales. Mauris tempus nunc ligula, sit amet congue tellus dignissim ut. Quisque ornare, enim nec fringilla lacinia, urna nulla fringilla erat, vitae aliquam sapien urna in nunc. Maecenas rutrum, orci in ornare egestas, nisl enim vestibulum nulla, at faucibus massa nibh laoreet dolor.\"},{\"insert\":\"\\n\"},{\"attributes\":{\"bold\":true},\"insert\":\"Mauris lectus augue, maximus a vehicula et, placerat quis erat. Etiam eu dapibus enim, ac gravida massa. Duis nec rutrum erat. Sed consectetur, nunc ut auctor iaculis, nunc neque placerat orci, in rutrum justo elit eleifend ex. Proin tristique quam et commodo consectetur. Mauris et velit eget dolor facilisis varius. Vivamus eros orci, volutpat vitae ex ullamcorper, commodo vehicula nunc. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer nulla ipsum, vestibulum gravida lobortis et, aliquam eu turpis. Vivamus pharetra pellentesque massa, vel vehicula urna vulputate in.\"},{\"insert\":\"\\nPellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Etiam varius risus et pretium malesuada. Maecenas ultricies ullamcorper arcu ac laoreet. Aliquam eleifend cursus condimentum. Nam sed ornare erat. Fusce ac dui ligula. Suspendisse elementum nibh venenatis aliquet malesuada.\\n\"}]}";
            var serializer = UboraStoreOptionsConfigurer.CreateConfiguredJsonSerializer();

            // Act
            var quill = new QuillDelta(initialValue);
            var serialized = serializer.ToJson(quill);
            var deserialized = (QuillDelta) serializer.FromJson(typeof(QuillDelta), serialized);

            // Assert
            deserialized.Value.Should().Be(initialValue);

            serialized.Length.Should().BeLessThan(initialValue.Length);
        }
    }
}
