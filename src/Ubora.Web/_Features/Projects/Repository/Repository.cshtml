@using Ubora.Web._Features.Projects._Shared
@model Ubora.Web._Features.Projects.Repository.ProjectRepositoryViewModel

@{
    ViewData["Title"] = "Repository";
    ViewData["MenuOption"] = ProjectMenuOption.Repository;
}

<div class="layout-columns">
    <div class="layout-sidemenu">
        @Html.Partial("AddFilePartial", Model.AddFileViewModel)
    </div>

    <div class="layout-content">
        <section class="medium-width">
            @foreach (var files in Model.AllFiles)
            {
                <div class="repository-folder">
                    <h2>@files.Key</h2>

                    <table class="table table-filelist full-width">
                        <tr>
                            <th></th>
                            <th>File name</th>
                            <th>Revision number</th>
                            <th>Size (kB)</th>
                            <th>Comment</th>
                        </tr>

                        @foreach (var file in files)
                        {
                            <tr class="table-row-content-center">
                                <td>
                                    <a href="@Url.Action("DownloadFile", new {fileId=file.Id})" title="Download file" aria-label="Download file">
                                        <i class="file-list--item-control material-icons">file_download</i>
                                    </a>

                                    <a href="@Url.Action("UpdateFile", new {fileId=file.Id})" title="Update file" aria-label="Update file">
                                        <i class="file-list--item-control material-icons">file_upload</i>
                                    </a>

                                    @if (Model.IsProjectLeader)
                                    {
                                        <a href="@Url.Action("HideFile", new {fileId=file.Id})" title="Delete file forever" aria-label="Delete file forever">
                                            <i class="file-list--item-control material-icons">delete_forever</i>
                                        </a>
                                    }

                                    <a href="@Url.Action("FileHistory", new {fileId=file.Id})" title="File history" aria-label="File history">
                                        <i class="file-list--item-control material-icons">history</i>
                                    </a>
                                </td>
                                <td>@file.FileName</td>
                                <td>@file.RevisionNumber</td>
                                <td>@file.FileSizeInKbs</td>
                                <td>@file.Comment</td>
                            </tr>
                        }
                    </table>
                </div>
            }
        </section>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.js">
    </script>
    <script>
    Dropzone.autoDiscover = false;
    $(document).ready(function () {
        var myDropzone = new Dropzone("div#my-dropzone", {
            url: '@Url.Action("AddFile","Repository")',
            autoProcessQueue: false,
            paramName: parameterName,
            uploadMultiple: true
        });

        myDropzone.on('sending', function (file, xhr, formData) {
            if ($("#FolderName").val().length != 0) {
                formData.append('FolderName', $("#FolderName").val());
            }
            formData.append('Comment', $("#Comment").val());
        });

        $('#btnSubmit').on('click', function () {
            if (myDropzone.files.length > 0) {
                 myDropzone.processQueue();
            }
        });

        myDropzone.on('success', function () {
            window.location.reload();
        });

        //Ignore to appending [n] to name
        function parameterName(){
            return "ProjectFiles";
        }
    });
    </script>
}